{% extends "base.html" %}
{% block title %}Banka Hesapları - GelirGiderGG{% endblock %}
{% block content %}
<div class="container mt-4">
    <!-- Özet Kutuları -->
    <div class="row mb-4">
        <div class="col-12 mb-3">
            <div class="p-4 bg-primary text-white rounded-4 shadow-sm">
                <div class="fs-5">Toplam Varlık (TL Karşılığı)</div>
                <div class="display-5 fw-bold">₺{{ '%.2f'|format(accounts|sum(attribute='balance')) }}</div>
                <div class="small">Tüm hesapların TL karşılığı</div>
            </div>
        </div>
        <div class="col-12 mb-3">
            <div class="p-4 bg-success text-white rounded-4 shadow-sm">
                <div class="fs-5">Toplam TRY</div>
                <div class="display-5 fw-bold">₺{{ '%.2f'|format(accounts|sum(attribute='balance')) }}</div>
                <div class="small">TL hesaplar toplamı</div>
            </div>
        </div>
    </div>
    <!-- Kartlar -->
    <div class="row g-4 mb-4">
        {% for acc in accounts %}
        <div class="col-md-4 col-12">
            <div class="card h-100 shadow-sm border-{{ loop.index0 % 2 == 0 and 'primary' or 'success' }}" style="border-width:2px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <i class="fas fa-university me-2 text-{{ loop.index0 % 2 == 0 and 'primary' or 'success' }}"></i>
                            <b>{{ acc.account_name }}</b>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('edit_bank_account', account_id=acc.id) }}">Düzenle</a></li>
                                <li>
                                    <form action="{{ url_for('delete_bank_account', account_id=acc.id) }}" method="post" style="display:inline;">
                                        <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Bu banka hesabını silmek istediğinizden emin misiniz?');">Sil</button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-2 text-muted small">{{ acc.bank_name }} ({{ acc.currency or 'TRY' }})</div>
                    <div class="fw-bold fs-4 text-success">₺{{ '%.2f'|format(acc.balance) }}</div>
                    <div class="text-muted small">IBAN: {{ acc.iban }}</div>
                    <div class="text-muted small">{{ acc.account_type or 'Vadesiz Hesap' }}</div>
                    <a href="#" class="btn btn-link p-0 mt-2">Hesap Detayları</a>
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalIn{{ acc.id }}">Para Al</button>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalOut{{ acc.id }}">Para Gönder</button>
                        <a href="{{ url_for('account_transactions', account_id=acc.id) }}" class="btn btn-sm btn-info">Hesap Hareketleri</a>
                    </div>
                </div>
            </div>
            <!-- Para Alma Modalı -->
            <div class="modal fade" id="modalIn{{ acc.id }}" tabindex="-1" aria-labelledby="modalInLabel{{ acc.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form method="POST" action="{{ url_for('bank_transaction_in', account_id=acc.id) }}">
                    <div class="modal-header">
                      <h5 class="modal-title" id="modalInLabel{{ acc.id }}">Para Alma ({{ acc.account_name }})</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label class="form-label">Tutar</label>
                        <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Açıklama</label>
                        <input type="text" class="form-control" name="description">
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                      <button type="submit" class="btn btn-success">Ekle</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- Para Gönderme Modalı -->
            <div class="modal fade" id="modalOut{{ acc.id }}" tabindex="-1" aria-labelledby="modalOutLabel{{ acc.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form method="POST" action="{{ url_for('bank_transaction_out', account_id=acc.id) }}">
                    <div class="modal-header">
                      <h5 class="modal-title" id="modalOutLabel{{ acc.id }}">Para Gönder ({{ acc.account_name }})</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label class="form-label">Tutar</label>
                        <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Açıklama</label>
                        <input type="text" class="form-control" name="description">
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                      <button type="submit" class="btn btn-warning">Gönder</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- Hızlı İşlemler -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex gap-4">
                <!-- <a href="#" class="text-primary"><i class="fas fa-plus-circle me-1"></i> Para Yatır/Çek</a> -->
                <a href="#" class="text-primary"><i class="fas fa-exchange-alt me-1"></i> Hesaplar Arası Transfer</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<script>
// Döviz kuru ile TL karşılığını otomatik göster
async function updateTLEquivalent() {
    const amount = parseFloat(document.getElementById('amount_invested')?.value || document.getElementById('amount')?.value) || 0;
    const currency = document.getElementById('currency').value;
    if (currency === 'TRY' || !amount) {
        document.getElementById('tl-equivalent-group').style.display = 'none';
        return;
    }
    document.getElementById('tl-equivalent-group').style.display = '';
    document.getElementById('tl-equivalent').value = 'Hesaplanıyor...';
    try {
        const resp = await fetch(`https://doviz.dev/v1/${currency.toLowerCase()}.json`);
        const data = await resp.json();
        const key = currency.toUpperCase() + 'TRY';
        const rate = data[key] || 1.0;
        document.getElementById('tl-equivalent').value = (amount * rate).toFixed(2) + ' ₺';
    } catch {
        document.getElementById('tl-equivalent').value = 'Kur alınamadı';
    }
}
document.getElementById('currency').addEventListener('change', updateTLEquivalent);
document.getElementById('amount_invested')?.addEventListener('input', updateTLEquivalent);
document.getElementById('amount')?.addEventListener('input', updateTLEquivalent);
</script> 